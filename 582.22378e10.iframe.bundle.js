"use strict";(self.webpackChunkworkflow_client=self.webpackChunkworkflow_client||[]).push([[582],{"./src/custom-surf/plugins/RenderDiagram.tsx":function(__unused_webpack_module,__webpack_exports__,__webpack_require__){__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,{default:function(){return plugins_RenderDiagram}});var call_out=__webpack_require__("./node_modules/@elastic/eui/es/components/call_out/call_out.js"),panel=__webpack_require__("./node_modules/@elastic/eui/es/components/panel/panel.js"),errorboundary=__webpack_require__("./node_modules/@sentry/react/esm/errorboundary.js"),slicedToArray=__webpack_require__("./node_modules/@babel/runtime/helpers/esm/slicedToArray.js"),regeneratorRuntime=__webpack_require__("./node_modules/@babel/runtime/helpers/esm/regeneratorRuntime.js"),asyncToGenerator=__webpack_require__("./node_modules/@babel/runtime/helpers/esm/asyncToGenerator.js"),classCallCheck=__webpack_require__("./node_modules/@babel/runtime/helpers/esm/classCallCheck.js"),createClass=__webpack_require__("./node_modules/@babel/runtime/helpers/esm/createClass.js"),inherits=__webpack_require__("./node_modules/@babel/runtime/helpers/esm/inherits.js"),createSuper=__webpack_require__("./node_modules/@babel/runtime/helpers/esm/createSuper.js"),code_block=__webpack_require__("./node_modules/@elastic/eui/es/components/code/code_block.js"),link_link=__webpack_require__("./node_modules/@elastic/eui/es/components/link/link.js"),flex_group=__webpack_require__("./node_modules/@elastic/eui/es/components/flex/flex_group.js"),flex_item=__webpack_require__("./node_modules/@elastic/eui/es/components/flex/flex_item.js"),card=__webpack_require__("./node_modules/@elastic/eui/es/components/card/card.js"),react=__webpack_require__("./node_modules/react/index.js"),lib=__webpack_require__("./node_modules/react-network-diagrams/lib/index.js"),react_router_dom=__webpack_require__("./node_modules/react-router-dom/esm/react-router-dom.js"),ApplicationContext=__webpack_require__("./src/utils/ApplicationContext.ts"),Utils=__webpack_require__("./src/utils/Utils.ts"),equipStyles_equipServers="#2ca02c",equipStyles_equipRouters="#1f77b4",equipStyles_equipOptical="#2c4e95",equipStyles_equipPdus="#9900ff",equipStyles_equipSwitches="#ff7f0e",equipStyles_equipPanels="#4d4d4d",stylesMap={equipmentToEquipment:{node:{normal:{stroke:"#737373",strokeWidth:4,fill:"none"},highlighted:{stroke:"#b1b1b1",strokeWidth:4,fill:"#b1b1b1"}},line:{normal:{stroke:"#ff7f0e",strokeWidth:3,fill:"none"},highlighted:{stroke:"#4EC1E0",strokeWidth:4,fill:"none"}},label:{normal:{fill:"#9D9D9D",fontFamily:"verdana, sans-serif",fontSize:10}}},optical:{node:{normal:{stroke:"#737373",strokeWidth:4,fill:"none"},highlighted:{stroke:"#b1b1b1",strokeWidth:4,fill:"#b1b1b1"}},line:{normal:{stroke:"#1f77b4",strokeWidth:3,fill:"none"},highlighted:{stroke:"#4EC1E0",strokeWidth:4,fill:"none"}},label:{normal:{fill:"#9D9D9D",fontFamily:"verdana, sans-serif",fontSize:10}}},leased:{node:{normal:{stroke:"#737373",strokeWidth:4,fill:"none"},highlighted:{stroke:"#b1b1b1",strokeWidth:4,fill:"#b1b1b1"}},line:{normal:{stroke:"#2ca02c",strokeWidth:3,fill:"none"},highlighted:{stroke:"#4EC1E0",strokeWidth:4,fill:"none"}},label:{normal:{fill:"#9D9D9D",fontFamily:"verdana, sans-serif",fontSize:10}}},darkFiber:{node:{normal:{stroke:"#737373",strokeWidth:4,fill:"none"},highlighted:{stroke:"#b1b1b1",strokeWidth:4,fill:"#b1b1b1"}},line:{normal:{stroke:"#737373",strokeWidth:2,fill:"none"},highlighted:{stroke:"#4EC1E0",strokeWidth:3,fill:"none"}},label:{normal:{fill:"#9D9D9D",fontFamily:"verdana, sans-serif",fontSize:10}}},crossConnect:{node:{normal:{stroke:"#737373",strokeWidth:4,fill:"none"},highlighted:{stroke:"#b1b1b1",strokeWidth:4,fill:"#b1b1b1"}},line:{normal:{stroke:"#535353",strokeWidth:1,fill:"none"},highlighted:{stroke:"#4EC1E0",strokeWidth:2,fill:"none"}},label:{normal:{fill:"#9D9D9D",fontFamily:"verdana, sans-serif",fontSize:10}}},coupler:{node:{normal:{stroke:"#737373",strokeWidth:4,fill:"none"},highlighted:{stroke:"#b1b1b1",strokeWidth:4,fill:"#b1b1b1"}},line:{normal:{stroke:"#737373",strokeWidth:1,fill:"#D5D5D5"},highlighted:{stroke:"#4EC1E0",strokeWidth:2,fill:"#D5D5D5"}},label:{normal:{fill:"#9D9D9D",fontFamily:"verdana, sans-serif",fontSize:10}}},endpoint:{node:{normal:{fill:"none",stroke:"#DBDBDB",strokeWidth:4,shape:"square"}},label:{normal:{fill:"#9D9D9D",fontSize:10,fontFamily:"verdana, sans-serif"}}},panelCoupler:{node:{normal:{stroke:"#737373",strokeWidth:1,fill:"#F8F8F8"},highlighted:{stroke:"#4EC1E0",strokeWidth:2,fill:"#F8F8F8"}},line:{normal:{stroke:"#737373",strokeWidth:1,fill:"#E8E8E8"},highlighted:{stroke:"#4EC1E0",strokeWidth:2,fill:"#E8E8E8"}},label:{normal:{fill:"#9D9D9D",fontFamily:"verdana, sans-serif",fontSize:10}}},panel:{stroke:"#E4E4E4",strokeWidth:1,fill:"#FFFFFF"},rack1:{stroke:"#737373",strokeWidth:1,fill:"#D5D5D5"},rack2:{stroke:"#000000",strokeWidth:2,fill:"#E8E8E8"},router:{line:{normal:{stroke:"#737373",strokeWidth:1,fill:equipStyles_equipRouters},selected:{stroke:"#333",strokeWidth:2,fill:equipStyles_equipRouters},muted:{stroke:"#696969",strokeWidth:1,opacity:.6,fill:equipStyles_equipRouters},highlighted:{stroke:"#4EC1E0",strokeWidth:1,fill:equipStyles_equipRouters}},label:{normal:{fill:"#FFFFFF",fontFamily:"verdana, sans-serif",fontSize:10},selected:{fill:"#FFFFFF",stroke:"none",fontSize:12},muted:{fill:"#696969",stroke:"none",fontSize:9,opacity:.6}}},switch:{line:{normal:{stroke:"#737373",strokeWidth:1,fill:equipStyles_equipSwitches},selected:{stroke:"#333",strokeWidth:2,fill:equipStyles_equipSwitches},muted:{stroke:"#696969",strokeWidth:1,opacity:.6,fill:equipStyles_equipSwitches},highlighted:{stroke:"#4EC1E0",strokeWidth:1,fill:equipStyles_equipSwitches}},label:{normal:{fill:"#FFFFFF",fontFamily:"verdana, sans-serif",fontSize:10},selected:{fill:"#FFFFFF",stroke:"none",fontSize:12},muted:{fill:"#696969",stroke:"none",fontSize:9,opacity:.6}}},server:{line:{normal:{stroke:"#737373",strokeWidth:1,fill:equipStyles_equipServers},selected:{stroke:"#333",strokeWidth:2,fill:equipStyles_equipServers},muted:{stroke:"#696969",strokeWidth:1,opacity:.6,fill:equipStyles_equipServers},highlighted:{stroke:"#4EC1E0",strokeWidth:1,fill:equipStyles_equipServers}},label:{normal:{fill:"#FFFFFF",fontFamily:"verdana, sans-serif",fontSize:10},selected:{fill:"#FFFFFF",stroke:"none",fontSize:12},muted:{fill:"#696969",stroke:"none",fontSize:9,opacity:.6}}},pdu:{line:{normal:{stroke:"#737373",strokeWidth:1,fill:equipStyles_equipPdus},selected:{stroke:"#333",strokeWidth:2,fill:equipStyles_equipPdus},muted:{stroke:"#696969",strokeWidth:1,opacity:.6,fill:equipStyles_equipPdus},highlighted:{stroke:"#4EC1E0",strokeWidth:1,fill:equipStyles_equipPdus}},label:{normal:{fill:"#FFFFFF",fontFamily:"verdana, sans-serif",fontSize:10},selected:{fill:"#FFFFFF",stroke:"none",fontSize:12},muted:{fill:"#696969",stroke:"none",fontSize:9,opacity:.6}}},transpor:{line:{normal:{stroke:"#737373",strokeWidth:1,fill:equipStyles_equipOptical},selected:{stroke:"#333",strokeWidth:2,fill:equipStyles_equipOptical},muted:{stroke:"#696969",strokeWidth:1,opacity:.6,fill:equipStyles_equipOptical},highlighted:{stroke:"#4EC1E0",strokeWidth:1,fill:equipStyles_equipOptical}},label:{normal:{fill:"#FFFFFF",fontFamily:"verdana, sans-serif",fontSize:10},selected:{fill:"#FFFFFF",stroke:"none",fontSize:12},muted:{fill:"#696969",stroke:"none",fontSize:9,opacity:.6}}},patchPanel:{line:{normal:{stroke:"#737373",strokeWidth:1,fill:equipStyles_equipPanels},selected:{stroke:"#333",strokeWidth:2,fill:equipStyles_equipPanels},muted:{stroke:"#696969",strokeWidth:1,opacity:.6,fill:equipStyles_equipPanels},highlighted:{stroke:"#4EC1E0",strokeWidth:1,fill:equipStyles_equipPanels}},label:{normal:{fill:"#FFFFFF",fontFamily:"verdana, sans-serif",fontSize:10},selected:{fill:"#FFFFFF",stroke:"none",fontSize:12},muted:{fill:"#696969",stroke:"none",fontSize:9,opacity:.6}}}},lineShapeMap_equipmentToEquipment="linear",lineShapeMap_optical="linear",lineShapeMap_leased="linear",lineShapeMap_darkFiber="linear",lineShapeMap_crossConnect="linear",lineShapeMap_coupler="square",jsx_runtime=__webpack_require__("./node_modules/react/jsx-runtime.js"),circuitTypeProperties={optical:{style:stylesMap.optical,lineShape:lineShapeMap_optical},leased:{style:stylesMap.leased,lineShape:lineShapeMap_leased},darkFiber:{style:stylesMap.darkFiber,lineShape:lineShapeMap_darkFiber},equipmentToEquipment:{style:stylesMap.equipmentToEquipment,lineShape:lineShapeMap_equipmentToEquipment},crossConnect:{style:stylesMap.crossConnect,lineShape:lineShapeMap_crossConnect},panelCoupler:{style:stylesMap.panelCoupler,lineShape:lineShapeMap_coupler,size:30,squareWidth:40,centerLine:!0}},graphList=[],NetworkDiagram=function(_React$Component){(0,inherits.Z)(NetworkDiagram,_React$Component);var _super=(0,createSuper.Z)(NetworkDiagram);function NetworkDiagram(props){var _this;return(0,classCallCheck.Z)(this,NetworkDiagram),(_this=_super.call(this,props)).context=void 0,_this.componentDidMount=function(){var _ref,_subscription$lrss$vc,_subscription$lrss,subscription=_this.props.subscription,_this$state=_this.state,imsServices=_this$state.imsServices,imsEndpoints=_this$state.imsEndpoints,isLoading=_this$state.isLoading,vcs=null!==(_ref=null!==(_subscription$lrss$vc=null===(_subscription$lrss=subscription.lrss)||void 0===_subscription$lrss?void 0:_subscription$lrss.vcs)&&void 0!==_subscription$lrss$vc?_subscription$lrss$vc:subscription.vcs)&&void 0!==_ref?_ref:[subscription.vc];!isLoading&&vcs.length>0&&(0,Utils.xb)(imsServices)&&(_this.setState({isLoading:!0}),vcs.forEach((function(vc,vcIndex){_this.context.customApiClient.serviceByImsServiceId(vc.ims_circuit_id).then((function(result){imsServices[vcIndex]=result,_this.setState({imsServices:imsServices}),(0,Utils.xb)(imsEndpoints[vcIndex])&&_this.populateEndpoints({service:result,recursive:!0,vc:vcIndex})}))})))},_this.populateEndpoints=function(_ref2){var service=_ref2.service,_ref2$recursive=_ref2.recursive,recursive=void 0!==_ref2$recursive&&_ref2$recursive,_ref2$vc=_ref2.vc,vc=void 0===_ref2$vc?0:_ref2$vc;if(!(0,Utils.xb)(service)&&recursive){var uniquePortPromises=(service.endpoints||[]).map(function(){var _ref3=(0,asyncToGenerator.Z)((0,regeneratorRuntime.Z)().mark((function _callee(endpoint){return(0,regeneratorRuntime.Z)().wrap((function _callee$(_context){for(;;)switch(_context.prev=_context.next){case 0:if("port"!==endpoint.type){_context.next=4;break}return _context.abrupt("return",_this.context.customApiClient.portByImsPortId(endpoint.id).then((function(result){return Object.assign(result,{serviceId:endpoint.id,endpointType:endpoint.type})})));case 4:if("internal_port"!==endpoint.type){_context.next=8;break}return _context.abrupt("return",_this.context.customApiClient.internalPortByImsPortId(endpoint.id).then((function(result){return Object.assign(result,{serviceId:endpoint.id,endpointType:endpoint.type})})));case 8:return _context.abrupt("return",_this.context.customApiClient.serviceByImsServiceId(endpoint.id).then((function(result){return["SP","MSP","SSP"].includes(result.product)?_this.context.customApiClient.portByImsServiceId(endpoint.id).then((function(result){return Object.assign(result,{serviceId:endpoint.id,endpointType:"port"})})):Object.assign(result,{serviceId:endpoint.id,endpointType:endpoint.type})})));case 9:case"end":return _context.stop()}}),_callee)})));return function(_x){return _ref3.apply(this,arguments)}}());Promise.all(uniquePortPromises).then((function(result){var imsEndpoints=_this.state.imsEndpoints;imsEndpoints[vc]=result.flat(),_this.setState({imsEndpoints:imsEndpoints})}))}},_this._findImsEndpoint=function(imsIndex,id){return _this.state.imsServices[imsIndex].endpoints.find((function(e){return e.id===id}))},_this._makeConnectionExplanation=function(endpoint,subscription){return(0,jsx_runtime.jsxs)(code_block.j2,{children:[subscription&&(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)("strong",{children:"subscription id:"})," ",(0,jsx_runtime.jsx)(react_router_dom.rU,{to:"/subscriptions/".concat(subscription.subscription_id),children:subscription.subscription_id}),(0,jsx_runtime.jsx)("br",{})]}),(0,jsx_runtime.jsx)("strong",{children:"interface:"})," ",endpoint.iface_type,(0,jsx_runtime.jsx)("br",{}),(0,jsx_runtime.jsx)("strong",{children:"physical port:"})," ",endpoint.port,(0,jsx_runtime.jsx)("br",{}),(0,jsx_runtime.jsx)("strong",{children:"connector:"})," ",endpoint.connector_type,(0,jsx_runtime.jsx)("br",{}),(0,jsx_runtime.jsx)("strong",{children:"fiber type:"})," ",endpoint.fiber_type,(0,jsx_runtime.jsx)("br",{}),(0,jsx_runtime.jsx)("strong",{children:"patch position:"})," ",endpoint.patchposition,(0,jsx_runtime.jsx)("br",{}),subscription&&(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)("strong",{children:"customer:"}),subscription.customer_name,(0,jsx_runtime.jsx)("br",{})]}),subscription&&subscription.customer_descriptions.length>0&&(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)("strong",{children:"customer descriptions:"}),subscription.customer_descriptions.map((function(item){return(0,jsx_runtime.jsx)("div",{children:item.description})})),(0,jsx_runtime.jsx)("br",{})]}),subscription&&(0,jsx_runtime.jsx)(link_link.p,{external:!0,target:"_blank",href:"https://netwerkdashboard.surf.net/subscription/".concat(subscription.subscription_id),"aria-label":"Link to netwerkdashboard",children:"Netwerkdashboard"})]})},_this._makeCircuitExplanation=function(circuit,subscription){return(0,jsx_runtime.jsxs)(code_block.j2,{children:[(0,jsx_runtime.jsx)("strong",{children:"speed:"})," ",circuit.service_speed,(0,jsx_runtime.jsx)("br",{}),(0,jsx_runtime.jsx)("strong",{children:"remote shutdown:"})," ",circuit.remote_port_shutdown?"yes":"no",(0,jsx_runtime.jsx)("br",{}),(0,jsx_runtime.jsx)("strong",{children:"speed policer:"})," ",circuit.speed_policer?"yes":"no",(0,jsx_runtime.jsx)("br",{}),(0,jsx_runtime.jsx)("strong",{children:"NSO service ID:"})," ",circuit.nso_service_id,(0,jsx_runtime.jsx)("br",{}),subscription&&(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)("strong",{children:"customer:"}),subscription.customer_name,(0,jsx_runtime.jsx)("br",{})]}),subscription&&subscription.customer_descriptions.length>0&&(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)("strong",{children:"customer descriptions:"}),subscription.customer_descriptions.map((function(item){return(0,jsx_runtime.jsx)("div",{children:item.description})})),(0,jsx_runtime.jsx)("br",{})]})]})},_this._onSelectionChange=function(e,value){var _value$split=value.split(","),_value$split2=(0,slicedToArray.Z)(_value$split,2),graphId=_value$split2[0],memberId=_value$split2[1];_this.setState({_selectedCircuit:graphList[graphId].members[memberId]||{}}),_this.setState({isTableOn:_this.state._selectedCircuit!=={}})},_this.state={_selectedCircuit:{},isTableOn:!1,imsEndpoints:[],imsServices:[],isLoading:!1},_this}return(0,createClass.Z)(NetworkDiagram,[{key:"shouldComponentUpdate",value:function shouldComponentUpdate(nextProps,nextState){return!0}},{key:"_buildTreeFromEndpoints",value:function _buildTreeFromEndpoints(){var _ref4,_subscription$lrss$vc2,_subscription$lrss2,_this2=this;graphList.splice(0,graphList.length);var subscription=this.props.subscription,imsEndpoints=this.state.imsEndpoints,vcs=null!==(_ref4=null!==(_subscription$lrss$vc2=null===(_subscription$lrss2=subscription.lrss)||void 0===_subscription$lrss2?void 0:_subscription$lrss2.vcs)&&void 0!==_subscription$lrss$vc2?_subscription$lrss$vc2:subscription.vcs)&&void 0!==_ref4?_ref4:[subscription.vc];if(!(0===imsEndpoints.length||imsEndpoints.length<vcs.length)&&subscription){var makeObject=function makeObject(expl,style,labelA,labelZ,label,index){return{explanation:expl,styleProperties:style,endpointStyle:stylesMap.endpoint,endpointLabelA:labelA,endpointLabelZ:labelZ,circuitLabel:label,navTo:index}};vcs.forEach((function(circuit,graphIndex){var memberList=[],graphTitle=null!==circuit.label?" - ".concat(circuit.label):"",subscription=_this2.props.subscription;imsEndpoints[graphIndex]&&(imsEndpoints[graphIndex].forEach((function(imsEndpoint){var endpointFromService=_this2._findImsEndpoint(graphIndex,imsEndpoint.serviceId);if(endpointFromService&&"trunk"!==endpointFromService.endpointType){var serviceSpeed=circuit.service_speed,connectionAdded=!1,vlanRange=endpointFromService.vlanranges.map((function(v){return"".concat(v.start,"-").concat(v.end)})).join(", "),connection=makeObject(_this2._makeConnectionExplanation(imsEndpoint,subscription),circuitTypeProperties.optical,"",0===memberList.length?vlanRange:"","".concat(serviceSpeed," @ ").concat(imsEndpoint.port),"".concat(graphIndex,",").concat(memberList.length));0===memberList.length&&(memberList.push(connection),connectionAdded=!0);var circuitMember=makeObject(_this2._makeCircuitExplanation(circuit),circuitTypeProperties.panelCoupler,"",connectionAdded?"":vlanRange,"".concat(imsEndpoint.node),"".concat(graphIndex,",").concat(memberList.length));memberList.push(circuitMember),connectionAdded&&memberList.push(makeObject(_this2._makeCircuitExplanation(circuit,subscription),circuitTypeProperties.optical,"","","".concat(serviceSpeed),"".concat(graphIndex,",").concat(memberList.length))),connectionAdded||(connection.navTo="".concat(graphIndex,",").concat(memberList.length),memberList.push(connection))}})),graphList.push({title:graphTitle,members:memberList}))}))}}},{key:"render",value:function render(){var _this3=this;return this._buildTreeFromEndpoints(),(0,jsx_runtime.jsxs)(flex_group.Gv,{children:[(0,jsx_runtime.jsx)(flex_item.J,{grow:7,children:graphList.length>0&&graphList.map((function(elem,index){return(0,jsx_runtime.jsx)(lib.fx,{memberList:elem.members,endpointLabelPosition:"bottomleftangled",yOffset:7,title:elem.title,onSelectionChange:_this3._onSelectionChange,endpointLabelOffset:30},index)}))}),(0,jsx_runtime.jsx)(flex_item.J,{grow:3,children:this.state.isTableOn&&(0,jsx_runtime.jsx)(card.cq,{title:"Details",children:this.state._selectedCircuit.explanation})})]})}}]),NetworkDiagram}(react.Component);NetworkDiagram.contextType=ApplicationContext.ZP;try{NetworkDiagram.displayName="NetworkDiagram",NetworkDiagram.__docgenInfo={description:"",displayName:"NetworkDiagram",props:{type:{defaultValue:null,description:"",name:"type",required:!0,type:{name:"enum",value:[{value:'"patchpanel"'},{value:'"combined"'}]}},subscription:{defaultValue:null,description:"",name:"subscription",required:!0,type:{name:"SubscriptionModel"}}}},"undefined"!=typeof STORYBOOK_REACT_CLASSES&&(STORYBOOK_REACT_CLASSES["src/custom-surf/components/subscriptionDetail/NetworkDiagram.tsx#NetworkDiagram"]={docgenInfo:NetworkDiagram.__docgenInfo,name:"NetworkDiagram",path:"src/custom-surf/components/subscriptionDetail/NetworkDiagram.tsx#NetworkDiagram"})}catch(__react_docgen_typescript_loader_error){}var topology,nodeSizeMap={hub:5.5,cloud:7},nodeShapeMap={L2VPNWOLK:"cloud",WOLK:"cloud"},edgeThicknessMap={"100G":9,"10G":3,"1G":1.5,subG:1},edgeColorMap=[{color:"#4da7c0",label:">=50 Gbps",range:[50,100]},{color:"#4da7c0",label:"20 - 50",range:[20,50]},{color:"#4da7c0",label:"10 - 20",range:[10,20]},{color:"#4da7c0",label:"5 - 10",range:[5,10]},{color:"#238b45",label:"2 - 5",range:[2,5]},{color:"#3690c0",label:"1 - 2",range:[1,2]},{color:"#74a9cf",label:"0 - 1",range:[0,1]}],pathColorMap={},pathWidthMap={},TopologyDiagram=function(_React$Component){(0,inherits.Z)(TopologyDiagram,_React$Component);var _super=(0,createSuper.Z)(TopologyDiagram);function TopologyDiagram(){var _this;(0,classCallCheck.Z)(this,TopologyDiagram);for(var _len=arguments.length,args=new Array(_len),_key=0;_key<_len;_key++)args[_key]=arguments[_key];return(_this=_super.call.apply(_super,[this].concat(args))).context=void 0,_this.state={mapMode:0,imsServices:[],imsEndpoints:[],isLoading:!1,nodesLoaded:!1,nodes:[],portSubscriptions:[],portsLoaded:!1,selectionType:null,selection:null,panelText:null,prefix:{},prefixesLoaded:[]},_this.prefixesLoaded=[],_this.componentDidMount=(0,asyncToGenerator.Z)((0,regeneratorRuntime.Z)().mark((function _callee(){var subscription,_this$state,imsServices,imsEndpoints,isLoading,vcs;return(0,regeneratorRuntime.Z)().wrap((function _callee$(_context){for(;;)switch(_context.prev=_context.next){case 0:if(subscription=_this.props.subscription,_this$state=_this.state,imsServices=_this$state.imsServices,imsEndpoints=_this$state.imsEndpoints,isLoading=_this$state.isLoading,_this$state.portsLoaded){_context.next=12;break}return _context.prev=3,_context.next=6,_this.getPortSubscriptions();case 6:_context.next=11;break;case 8:_context.prev=8,_context.t0=_context.catch(3),console.log("failed to get a subscription",_context.t0.config.url);case 11:_this.setState({portsLoaded:!0});case 12:vcs=subscription.vcs?subscription.vcs:[subscription.vc],!isLoading&&vcs.length>0&&(0,Utils.xb)(imsServices)&&(_this.setState({isLoading:!0}),vcs.forEach((function(vc,vcIndex){_this.context.customApiClient.serviceByImsServiceId(vc.ims_circuit_id).then((function(result){imsServices[vcIndex]=result,_this.setState({imsServices:imsServices}),(0,Utils.xb)(imsEndpoints[vcIndex])&&_this.populateEndpoints({service:result,recursive:!0,vc:vcIndex})}))})));case 14:case"end":return _context.stop()}}),_callee,null,[[3,8]])}))),_this.shouldComponentUpdate=function(newProps,newState){var portSubscriptions=newState.portSubscriptions,imsEndpoints=newState.imsEndpoints;return portSubscriptions.length>0&&imsEndpoints.length>0},_this.getPortSubscriptions=(0,asyncToGenerator.Z)((0,regeneratorRuntime.Z)().mark((function _callee2(){var subscription,promises,backlog;return(0,regeneratorRuntime.Z)().wrap((function _callee2$(_context2){for(;;)switch(_context2.prev=_context2.next){case 0:return subscription=_this.props.subscription,promises=[],backlog="IP"===subscription.product.product_type?[subscription.vc]:subscription.vc.esis,"IPS"===subscription.product.tag&&_this.context.apiClient.subscriptionsDetailWithModel(subscription.vc.sap.port_subscription_id).then((function(result){_this.setState({portSubscriptions:[result]})})),(backlog||[]).forEach((function(esi){(esi.saps||[]).forEach((function(sap){promises.push(_this.context.apiClient.subscriptionsDetailWithModel(sap.port_subscription_id).then((function(result){return result})))}))})),_context2.abrupt("return",Promise.all(promises).then((function(result){return _this.setState({portSubscriptions:result.flat()})})));case 6:case"end":return _context2.stop()}}),_callee2)}))),_this.populateEndpoints=function(_ref3){var service=_ref3.service,_ref3$recursive=_ref3.recursive,recursive=void 0!==_ref3$recursive&&_ref3$recursive,_ref3$vc=_ref3.vc,vc=void 0===_ref3$vc?0:_ref3$vc;if(!(0,Utils.xb)(service)&&recursive){var uniquePortPromises=(service.endpoints||[]).map(function(){var _ref4=(0,asyncToGenerator.Z)((0,regeneratorRuntime.Z)().mark((function _callee3(endpoint){return(0,regeneratorRuntime.Z)().wrap((function _callee3$(_context3){for(;;)switch(_context3.prev=_context3.next){case 0:if("port"!==endpoint.type){_context3.next=4;break}return _context3.abrupt("return",_this.context.customApiClient.portByImsPortId(endpoint.id).then((function(result){return Object.assign(result,{serviceId:endpoint.id,endpointType:endpoint.type})})));case 4:if("internal_port"!==endpoint.type){_context3.next=8;break}return _context3.abrupt("return",_this.context.customApiClient.internalPortByImsPortId(endpoint.id).then((function(result){return Object.assign(result,{serviceId:endpoint.id,endpointType:endpoint.type})})));case 8:return _context3.abrupt("return",_this.context.customApiClient.serviceByImsServiceId(endpoint.id).then((function(result){if(["SP","MSP","SSP"].includes(result.product))return _this.context.customApiClient.portByImsServiceId(endpoint.id).then((function(result){return Object.assign(result,{serviceId:endpoint.id,endpointType:"port"})}));if("AGGSP"===result.product){var internalPortId=result.endpoints.find((function(e){return"internal_port"===e.type}));return internalPortId?_this.context.customApiClient.internalPortByImsPortId(internalPortId.id).then((function(port){return Object.assign(port,{serviceId:endpoint.id})})):result}return Object.assign(result,{serviceId:endpoint.id,endpointType:endpoint.type})})));case 9:case"end":return _context3.stop()}}),_callee3)})));return function(_x){return _ref4.apply(this,arguments)}}());Promise.all(uniquePortPromises).then((function(result){var imsEndpoints=_this.state.imsEndpoints;imsEndpoints[vc]=result.flat(),_this.setState({imsEndpoints:imsEndpoints})}))}},_this._makeConnectionExplanation=function(endpoint,sap,sub){var block=sub.port,portmode=block&&block.port_mode?block.port_mode:"N/A",vlanRange=sap.vlanrange;return(0,jsx_runtime.jsxs)(code_block.j2,{children:[(0,jsx_runtime.jsx)("strong",{children:"interface :"})," ",endpoint.iface_type,(0,jsx_runtime.jsx)("br",{}),(0,jsx_runtime.jsx)("strong",{children:"physical port:"})," ",endpoint.port,(0,jsx_runtime.jsx)("br",{}),(0,jsx_runtime.jsx)("strong",{children:"connector :"})," ",endpoint.connector_type,(0,jsx_runtime.jsx)("br",{}),(0,jsx_runtime.jsx)("strong",{children:"fiber type :"})," ",endpoint.fiber_type,(0,jsx_runtime.jsx)("br",{}),(0,jsx_runtime.jsx)("strong",{children:"IMS service :"})," ",endpoint.serviceId,(0,jsx_runtime.jsx)("br",{}),(0,jsx_runtime.jsx)("strong",{children:"patch :"})," ",endpoint.patchposition,(0,jsx_runtime.jsx)("br",{}),(0,jsx_runtime.jsx)("strong",{children:"port mode :"})," ",portmode,(0,jsx_runtime.jsx)("br",{}),(0,jsx_runtime.jsx)("strong",{children:"vlan :"})," ",vlanRange,(0,jsx_runtime.jsx)("br",{}),(0,jsx_runtime.jsx)(link_link.p,{external:!0,target:"_blank",href:"https://netwerkdashboard.surf.net/subscription/".concat(sub.subscription_id),"aria-label":"Link to netwerkdashboard",children:"Netwerkdashboard"})]})},_this._makePrefixExplanation=function(endpoint,sub,sap){var _prefixInstance$tags;if((0,Utils.xb)(sap.prefixes))return(0,jsx_runtime.jsx)(code_block.j2,{});var prefixInstance=_this.state.prefix[sap.prefixes[0].owner_subscription_id];return prefixInstance?(0,jsx_runtime.jsxs)("div",{children:[endpoint&&_this._makeConnectionExplanation(endpoint,sap,sub),(0,jsx_runtime.jsxs)(code_block.j2,{children:[(0,jsx_runtime.jsx)("strong",{children:"asn :"})," ",prefixInstance.asn__label,(0,jsx_runtime.jsx)("br",{}),(0,jsx_runtime.jsx)("strong",{children:"prefix :"})," ",prefixInstance.prefix,(0,jsx_runtime.jsx)("br",{}),(0,jsx_runtime.jsx)("strong",{children:"state :"})," ",prefixInstance.state__label,(0,jsx_runtime.jsx)("br",{}),(0,jsx_runtime.jsx)("strong",{children:"tags :"})," ",null===(_prefixInstance$tags=prefixInstance.tags)||void 0===_prefixInstance$tags?void 0:_prefixInstance$tags.join(","),(0,jsx_runtime.jsx)("br",{})]})]}):(0,jsx_runtime.jsx)(code_block.j2,{children:"Not found"})},_this}return(0,createClass.Z)(TopologyDiagram,[{key:"handleSelectionChanged",value:function handleSelectionChanged(selectionType,selection){var n;this.setState({selectionType:selectionType,selection:selection}),"edge"===selectionType||(n=topology.names.find((function(e){return e.id===selection}))),this.setState({panelText:n?n.text:""})}},{key:"_makeNode",value:function _makeNode(id,label,x,y,type){return{capacity:"1G",label_dx:null,label_dy:null,label_position:"bottom",name:label,site:null,type:type||"hub",x:x,y:y,id:id,text:(0,jsx_runtime.jsx)("div",{})}}},{key:"_getNode",value:function _getNode(id){return this.state.nodes.find((function(node){return node.subscription_id===id}))}},{key:"_calculatePositionFor",value:function _calculatePositionFor(radius,index,n){return{x:radius*Math.cos(2*index*Math.PI/n),y:radius*Math.sin(2*index*Math.PI/n)}}},{key:"_updatePrefixInformation",value:function _updatePrefixInformation(sap){var _this2=this;if(!(0,Utils.xb)(sap.prefixes)&&!this.prefixesLoaded.includes(sap.prefixes[0])){var prefixSubscriptionId=sap.prefixes[0].owner_subscription_id;this.prefixesLoaded.push(prefixSubscriptionId),this.context.apiClient.subscriptionsDetailWithModel(prefixSubscriptionId).then((function(result){_this2.context.customApiClient.prefixById(result.ip_prefix.ipam_prefix_id).then((function(prefixData){var prefix=_this2.state.prefix;prefix[prefixSubscriptionId]=prefixData,_this2.setState({prefix:prefix})}))}))}}},{key:"_buildIP",value:function _buildIP(){var _this3=this,topology={names:[],nodes:[],edges:[],paths:[]},_this$state2=this.state,imsEndpoints=_this$state2.imsEndpoints,portSubscriptions=_this$state2.portSubscriptions,subscription=this.props.subscription;pathColorMap={};var wolk=this._makeNode("wolk","WOLK",120,60,"cloud");if(topology.names.push(wolk),topology.nodes.push(wolk),subscription.vc.saps)subscription.vc.saps.forEach((function(sap,index){var portSubscription=portSubscriptions.find((function(s){return s.subscription_id===sap.port_subscription_id}));if(_this3._updatePrefixInformation(sap),portSubscription){var block=portSubscription.port,endpoint=imsEndpoints[0].find((function(e){return e.serviceId===block.ims_circuit_id})),label=null!=endpoint&&endpoint.port?"".concat(null==endpoint?void 0:endpoint.node,"__").concat(null==endpoint?void 0:endpoint.port.replace(/\//g,"_")):null==endpoint?void 0:endpoint.name,point=_this3._calculatePositionFor(50,index,subscription.vc.saps.length),node=_this3._makeNode(sap.port_subscription_id,"".concat(portSubscription.product.tag,"_").concat(label),120+point.x,60+point.y,"hub");node.text=_this3._makePrefixExplanation(endpoint,portSubscription,sap),topology.names.push(node),topology.nodes.push(node)}}));else if(subscription.vc.sap){var sap=subscription.vc.sap,portSubscription=portSubscriptions.find((function(s){return s.subscription_id===sap.port_subscription_id}));if(this._updatePrefixInformation(sap),!portSubscription)return topology;var block=portSubscription.port,endpoint=imsEndpoints[0].find((function(e){return e.serviceId===block.ims_circuit_id})),label=null!=endpoint&&endpoint.port?"".concat(null==endpoint?void 0:endpoint.node,"__").concat(null==endpoint?void 0:endpoint.port.replace(/\//g,"_")):null==endpoint?void 0:endpoint.name,point=this._calculatePositionFor(50,1,1),node=this._makeNode(sap.port_subscription_id,"".concat(portSubscription.product.tag,"_").concat(label),120+point.x,60+point.y,"hub");node.text=this._makePrefixExplanation(endpoint,portSubscription,sap),topology.names.push(node),topology.nodes.push(node)}else console.log("Problem with resolving/handling the endpoints");return topology}},{key:"_build",value:function _build(){var _this4=this,topology={names:[],nodes:[],edges:[],paths:[]},_this$state3=this.state,imsEndpoints=_this$state3.imsEndpoints,portSubscriptions=_this$state3.portSubscriptions,subscription=this.props.subscription;if(pathColorMap={},0===portSubscriptions.length||0===imsEndpoints.length)return topology;var wolk=this._makeNode("wolk","WOLK",120,60,"cloud"),vc=subscription.vc;if(vc){var esiList=vc.esis;esiList.forEach((function(esi,esiIndex){var dependsOnCount=esi.saps.length;esi.saps.forEach((function(sap,index){var portSubscriptionId=sap.port_subscription_id,portSubscription=portSubscriptions.find((function(s){return s.subscription_id===portSubscriptionId}));if(portSubscription){var endpointId;endpointId=portSubscription.port.ims_circuit_id;var endpoint=imsEndpoints[0].find((function(e){return e.serviceId===endpointId})),portName=endpoint.port?endpoint.port.replace(/\//g,"_"):"AGGSP",nodeName="unknown_".concat(index);endpoint&&(nodeName=endpoint.node);var label="".concat(nodeName,"__").concat(portName),point=_this4._calculatePositionFor(50,esiIndex,esiList.length);dependsOnCount>1&&(point.y=point.y-10*index,pathColorMap["".concat(label,"__WOLK")]="cyan",pathWidthMap["".concat(label,"__WOLK")]=2);var graphNode=_this4._makeNode(portSubscriptionId,label,120+point.x,60+point.y,"hub");graphNode.text=_this4._makeConnectionExplanation(endpoint,sap,portSubscription),graphNode.y<60&&(graphNode.label_position="top"),topology.nodes.push(graphNode),topology.names.push(graphNode)}else console.log("failed to find subscription",portSubscriptionId)}))})),topology.names.push(wolk),topology.nodes.push(wolk)}return topology}},{key:"_makePaths",value:function _makePaths(){topology.nodes.forEach((function(node){var edge={capacity:"100G",ifaces:[{device_source:"bost-cr5",device_target:"newy-cr5",iface_source:"to_newy-cr5_ip-c",iface_target:"to_bost-cr1_ip-a",loc_source:node.name,loc_target:"WOLK"}],site:null,source:node.name,target:"WOLK",total_capacity:1e7};topology.edges.push(edge),topology.paths.push({ends:[],steps:[node.name,"WOLK"],name:"".concat(node.name,"__WOLK")})}))}},{key:"render",value:function render(){var _this5=this;topology="L2VPN"===this.props.subscription.product.product_type?this._build():this._buildIP(),this._makePaths();var drawingMethod=0===this.state.mapMode?"simple":"pathBidirectionalArrow",mapSelection={nodes:"node"===this.state.selectionType?[this.state.selection]:[],edges:"edge"===this.state.selectionType?[this.state.selection]:[]};return(0,jsx_runtime.jsxs)(flex_group.Gv,{justifyContent:"spaceAround",children:[(0,jsx_runtime.jsx)(flex_item.J,{grow:5,children:topology.names.length>0&&(0,jsx_runtime.jsx)(lib.X$,{topology:topology,bounds:{x1:-5,y1:5,x2:240,y2:120},edgeColorMap:edgeColorMap,edgeDrawingMethod:drawingMethod,edgeThinknessMap:edgeThicknessMap,nodeSizeMap:nodeSizeMap,nodeShapeMap:nodeShapeMap,stylesMap:stylesMap,pathColorMap:pathColorMap,pathWidthMap:pathWidthMap,showPaths:Object.keys(pathColorMap),selection:mapSelection,onSelectionChange:function onSelectionChange(selectionType,selection){return _this5.handleSelectionChanged(selectionType,selection)}},"traffic-map")}),(0,jsx_runtime.jsx)(flex_item.J,{grow:3,style:{minWidth:300},children:(0,jsx_runtime.jsx)(card.cq,{title:"Details",children:this.state.panelText})}),(0,jsx_runtime.jsx)(flex_item.J,{grow:2,style:{minWidth:100}})]})}}]),TopologyDiagram}(react.Component);TopologyDiagram.contextType=ApplicationContext.ZP;try{TopologyDiagram.displayName="TopologyDiagram",TopologyDiagram.__docgenInfo={description:"",displayName:"TopologyDiagram",props:{subscription:{defaultValue:null,description:"",name:"subscription",required:!0,type:{name:"SubscriptionModel"}}}},"undefined"!=typeof STORYBOOK_REACT_CLASSES&&(STORYBOOK_REACT_CLASSES["src/custom-surf/components/subscriptionDetail/TopologyDiagram.tsx#TopologyDiagram"]={docgenInfo:TopologyDiagram.__docgenInfo,name:"TopologyDiagram",path:"src/custom-surf/components/subscriptionDetail/TopologyDiagram.tsx#TopologyDiagram"})}catch(__react_docgen_typescript_loader_error){}var message=__webpack_require__("./node_modules/react-intl/lib/src/components/message.js"),Lookups=__webpack_require__("./src/utils/Lookups.ts");function ErrorFallback(_ref){var componentName=_ref.componentName;return(0,jsx_runtime.jsx)(call_out.Kq,{title:"An unhandled error occurred",color:"danger",iconType:"alert",children:(0,jsx_runtime.jsxs)("p",{children:["An unhandled error occurred in the ",componentName," and was logged to Sentry. This could indicate a missing resource type in an external system."]})})}function RenderDiagram(_ref2){var subscription=_ref2.subscription,_useContext=(0,react.useContext)(ApplicationContext.ZP),organisations=_useContext.organisations,products=_useContext.products;if("active"!==subscription.status||!subscription.insync)return null;var header=(0,jsx_runtime.jsx)("h2",{children:(0,jsx_runtime.jsx)(message.Z,{id:"subscription.network_diagrams"})}),enrichedSubscription=(0,Lookups.yR)(subscription,organisations,products);return"LightPath"===subscription.product.product_type?(0,jsx_runtime.jsxs)("div",{children:[header,(0,jsx_runtime.jsx)(panel.xe,{hasShadow:!1,paddingSize:"l",children:(0,jsx_runtime.jsx)(errorboundary.SV,{beforeCapture:function beforeCapture(scope){scope.setTag("component","NetworkDiagram")},fallback:function fallback(){return(0,jsx_runtime.jsx)(ErrorFallback,{componentName:"NetworkDiagram"})},children:(0,jsx_runtime.jsx)(NetworkDiagram,{type:"patchpanel",subscription:enrichedSubscription})})})]}):["L2VPN","IP"].includes(subscription.product.product_type)?(0,jsx_runtime.jsxs)("div",{children:[header,(0,jsx_runtime.jsx)(panel.xe,{hasShadow:!1,paddingSize:"l",children:(0,jsx_runtime.jsx)(errorboundary.SV,{beforeCapture:function beforeCapture(scope){scope.setTag("component","TopologyDiagram")},fallback:function fallback(){return(0,jsx_runtime.jsx)(ErrorFallback,{componentName:"TopologyDiagram"})},children:(0,jsx_runtime.jsx)(TopologyDiagram,{subscription:subscription})})})]}):null}var plugins_RenderDiagram=RenderDiagram;try{RenderDiagram.displayName="RenderDiagram",RenderDiagram.__docgenInfo={description:"",displayName:"RenderDiagram",props:{subscription:{defaultValue:null,description:"",name:"subscription",required:!0,type:{name:"SubscriptionModel"}}}},"undefined"!=typeof STORYBOOK_REACT_CLASSES&&(STORYBOOK_REACT_CLASSES["src/custom-surf/plugins/RenderDiagram.tsx#RenderDiagram"]={docgenInfo:RenderDiagram.__docgenInfo,name:"RenderDiagram",path:"src/custom-surf/plugins/RenderDiagram.tsx#RenderDiagram"})}catch(__react_docgen_typescript_loader_error){}}}]);